<html>
<head>
<link rel="stylesheet" type="text/css" href="general.css" />
</head>
<body>
<div class="title_main">WED file format</div>
<br />
<div class="fileheader">Applies to:</div>
<div class="indent1">BG1, BG1: TotS, BG2, BG2: ToB, PST, IWD, IWD:HoW, IWD:TotL, IWD2</div><br />

<div class="fileheader">General Description</div>
<div class="indent1">
The main function of WED files is to map together the physical representation of the terrain with the tilesets. The format describes the  area walls and doors, grouped by contiguity. In essence, the WED file is the actual map, but without containers, actors, or items.<br />
</div>
<br />

<div class="fileheader">Detailed Description</div>
<div class="indent1">
A basic area is drawn using tiles. Each location where a tile can be drawn is called a tile cell. Tile cells are numbered, starting from 0 (at the top-left corner), and increasing by one as you move to the right. Therefore a tile cell's number can be computed by <span class="mono">y*width+x</span>.<br />
Layers can be drawn on top of the tiles if necessary, these layers are called overlays, and there can be several overlays on each area. The overlays are drawn sequentially, starting at overlay 0.<br />
The process of drawing an area is as follows: <br />
<div class="indent1">
The cell number acts as an index into a tilemap structure.<br />
This give a &quot;tile lookup index&quot; which is an index into the tile indices lookup table.<br />
The tile indices lookup table gives the index into the actual tileset, at which point, the tile is drawn.<br />
The process is repeated for each required overlay (using the associated overlay tilemap / tile indices).<br />
</div>
Tiles in the tileset appear to be hardcoded to a size of 64x64 pixels, and cells in the searchmap appear to be hardcoded to a size of 16x16 pixels.<br />
<br />
Overall structure:<br />
<div class="indent1">
  <li><a href="#wedV1_3_Header">Header</a>
  <li><a href="#wedV1_3_Overlay">Overlays</a>
  <li><a href="#wedV1_3_SecHeader">Secondary header</a>
  <li><a href="#wedV1_3_Doors">Doors</a>
  <li><a href="#wedV1_3_TileMap">Tilemap structures</a>
  <li><a href="#wedV1_3_DoorTiles">Door tile cell indices</a>
  <li><a href="#wedV1_3_TileIndices">Tile indices (lookup table)</a>
  <li><a href="#wedV1_3_WallGroup">Wall groups</a>
  <li><a href="#wedV1_3_Polygon">Polygons</a>
  <li><a href="#wedV1_3_PolygonIndices">Polygon indices (lookup table)</a>
  <li><a href="#wedV1_3_Vertices">Vertices</a></li>
</div>
<br />
</div>

<div class="fileheader"><a name="wedV1_3_Header">WED V1.3 Header</a></div><br />
<div class="indent1">
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (char array)</td>
      <td>Signature ('WED ')</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (char array)</td>
      <td>Version ('V1.3')</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Number of <a href="#wedV1_3_Overlay">overlays</a> (including the
        base layer)</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>4 (dword)</td>
      <td>Number of <a href="#wedV1_3_Doors">doors</a></td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>4 (dword)</td>
      <td>Offset (from start of file) to <a href="#wedV1_3_Overlay">overlays</a></td>
    </tr>
    <tr>
      <td>0x0014</td>
      <td>4 (dword)</td>
      <td>Offset (from start of file) to <a href="#wedV1_3_SecHeader">secondary
        header</a></td>
    </tr>
    <tr>
      <td>0x0018</td>
      <td>4 (dword)</td>
      <td>Offset (from start of file) to <a href="#wedV1_3_Doors">doors</a></td>
    </tr>
    <tr>
      <td>0x001c</td>
      <td>4 (dword)</td>
      <td>Offset (from start of file) to <a href="#wedV1_3_DoorTiles">door
        tile cell indices</a></td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="wedV1_3_Overlay">WED V1.3 Overlays</a></div><br />
<div class="indent1">
Each overlay is represented by a tileset. These overlays will each cover a
part of the map. Which parts of the map have which overlays is coded for in the <a href="#wedV1_3_TileMap">tilemap</a>
section. For instance, bodies of water are typically done as overlays in BG. (WTRIV
is a tileset used for rivers, WTLAKE is a tileset used for lakes).</a><br /><br />

<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>2 (word)</td>
      <td>Width (in tiles)</td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td>2 (word)</td>
      <td>Height (in tiles)</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>8 (resref)</td>
      <td>Name of <a href="tis_v1.htm"> Tileset (resource type 0x3eb)</a></td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>4 (unknown)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>4 (dword)</td>
      <td>Offset to <a href="#wedV1_3_TileMap">tilemap</a> for this overlay</td>
    </tr>
    <tr>
      <td>0x0014</td>
      <td>4 (dword)</td>
      <td>Offset to <a href="#wedV1_3_TileIndices">tile index lookup</a> for
        this overlay</td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="wedV1_3_SecHeader">WED V1.3 Secondary header</a></div><br />
<div class="indent1">
This 'secondary' header contains more offsets. This section is probably due to 
incompatibilities between earlier internal versions of the WED format (V1.0, V1.1, and V1.2) 
and the current version.<br /><br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (dword)</td>
      <td>Number of <a href="#wedV1_3_Polygon">polygons</a> used to
        represent walls</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (dword)</td>
      <td>Offset to <a href="#wedV1_3_Polygon">polygons</a></td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Offset to <a href="#wedV1_3_Vertices">Vertices</a></td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>4 (dword)</td>
      <td>Offset to <a href="#wedV1_3_WallGroup">Wall groups</a></td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>4 (dword)</td>
      <td>Offset to <a href="#wedV1_3_PolygonIndices">Polygon indices lookup
        table</a></td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="wedV1_3_Doors">WED V1.3 Doors</a></div><br />
<div class="indent1">
This section describes &quot;doors&quot; (or any object which acts like a door;
ie has an open state and a closed state, and optionally blocks certain cells 
from being reached). The <a href="#wedV1_3_DoorTiles">door tile cells</a> for 
a given door are those cells which are impeded, and whose graphics change when this 
door is closed. See the <a href="#wedV1_3_DoorTiles">door tile cell indices</a> 
section for details.<br /><br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>8 (char array)</td>
      <td>Name of door (matched on in AREA file?)</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>2 (word)</td>
      <td><span class="unknown">Unknown... Open/closed? (1==closed)</span></td>
    </tr>
    <tr>
      <td>0x000a</td>
      <td>2 (word)</td>
      <td>First <a href="#wedV1_3_DoorTiles">door tile cell</a> index</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>2 (word)</td>
      <td>Count of <a href="#wedV1_3_DoorTiles">door tile cells</a> for this
        door</td>
    </tr>
    <tr>
      <td>0x000e</td>
      <td>2 (word)</td>
      <td>Count of <a href="#wedV1_3_Polygon">polygons used to represent
        door in &quot;door open&quot; state</a></td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>2 (word)</td>
      <td>Count of <a href="#wedV1_3_Polygon">polygons used to represent
        door in &quot;door closed&quot; state</a></td>
    </tr>
    <tr>
      <td>0x0012</td>
      <td>4 (dword)</td>
      <td>Offset from start of file to <a href="#wedV1_3_Polygon">polygons</a>
        used to represent door in &quot;door open&quot; state</td>
    </tr>
    <tr>
      <td>0x0016</td>
      <td>4 (dword)</td>
      <td>Offset from start of file to <a href="#wedV1_3_Polygon">polygons</a>
        used to represent door in &quot;door closed&quot; state</td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="wedV1_3_TileMap">WED V1.3 Tilemap structures</a></div><br />
<div class="indent1">
For each &quot;tile cell&quot; in a overlay, there is one tilemap structure.
These structures tell us which tile(s) from the tileset resource are to be used
for this tile cell. Each tile cell must have one tileset resource; those which
are referenced by the <a href="#wedV1_3_DoorTiles">door tile cells</a> of a
door must have 2 -- one for the &quot;open&quot; state, and one for the
&quot;closed&quot; state. Some tile cells are animated, and they will use a
range of tile indices from the <a href="#wedV1_3_TileIndices">tile indices
lookup table.</a><br /><br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>2 (word)</td>
      <td>Start index in <a href="#wedV1_3_TileIndices">tile index lookup
        table</a> of primary (default) tile</td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td>2 (word)</td>
      <td>Count of tiles in <a href="#wedV1_3_TileIndices">tile index lookup
        table</a> for primary (default) tile</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>2 (word)</td>
      <td>Index from <a href="tis_v1.htm">TIS file</a>
        of secondary (alternate) tile (i.e. tile for closed state, if tile has an
        open/closed state) and also for overlays indication (tiles with marked
        overlay area, by &quot;green&quot; color)</td>
    </tr>
    <tr>
      <td>0x0006</td>
      <td>1 (byte)</td>
      <td>The upper 7 bits of this byte are a bitmap indicating which of the
        overlays are to be drawn. The 0th overlay (the base layer) is always
        drawn.</td>
    </tr>
    <tr>
      <td>0x0007</td>
      <td>3 (bytes)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="wedV1_3_DoorTiles">WED V1.3 Door tile cells</a></div><br />
<div class="indent1">
Each door has associated to it a range of tile indices in this array. When
the door is opened or closed, all the tiles whose indices are contained in the
specified region of this array, have their state toggled. This means that the
tile becomes (un)passable and that the tile graphic is switched between the
default and alternate tile graphic. (In short, these are indices into the <a href="#wedV1_V1_3_TileMap">tilemap</a>
array.)
</div>
<br />

<div class="fileheader"><a name="wedV1_3_TileIndices">WED V1.3 Tile index lookup table</a></div><br />
<div class="indent1">
The '<a href="#wedV1_3_TileMap">tile map</a>' structures reference
indices into this table. The 'tile counts' in the <a href="#wedV1_V1_3_TileMap">tilemap</a>
table are counts of indices in this table. This maps tile indices from the WED
tile indices into the appropriate tile indices for the particular tileset file
which the overlay in question references. This, then, is just a big array of
little-endian 16-bit words.
</div>
<br />

<div class="fileheader"><a name="wedV1_3_WallGroup">WED V1.3 Wall groups</a></div><br />
<div class="indent1">
Representations of continuous walls and doors need to be stored to determine
where the characters can and cannot walk (actually where creatures animations
are shaded and where they are not, since access to the certain places on map is
determined by search auxiliary map of area). This is achieved by creating <a href="#wedV1_3_Polygon">polygons</a>
for walls and grouping them together by connectivity. Doors in their open/closed
state can be formed of an arbitrary number of <a href="#wedV1_3_Polygon">polygons</a>.
For instance, a double door could be one <a href="#wedV1_3_Polygon">polygon</a>
when it is closed, and two when it is open. These <a href="#wedV1_3_Polygon">wall
groups</a> are sets of indices in the <a href="#wedV1_3_PolygonIndices">polygon
indices lookup table</a>, which in turn point into the <a href="#wedV1_3_Polygon">polygon
table.</a>
One thing worth remembering is that one wall group has the following
dimensions : 10 tiles * 7.5 tiles, thus all areas should have the according to
the background overlay amount of wall groups sections stored here i.e. area with
dimensions 80*60 tiles should have 64 wall groups.<a href="../General/Wallgroups.htm"><br />
For more details look here.</a><br /><br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (datatype)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>2 (word)</td>
      <td>Start <a href="#wedV1_3_PolygonIndices">polygon index</a></td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td>2 (word)</td>
      <td><a href="#wedV1_3_PolygonIndices">Polygon index count</a></td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="wedV1_3_Polygon">WED V1.3 Polygons</a></div><br />
<div class="indent1">
A polygon is a list of vertices, a minimum bounding box, and some unknown
state information.<br />
The order of vertices can be important when describing polygons. 
For doors walls the vertices have to be listed clockwise, starting with the rightmost vertex first. 
If there are two or more vertex on the same rightmost vertical line you have to start with the one at the
lowest point. For normal walls the vertices can be listed in clockwise or anti-clockwise order, 
starting with the most lowest vertex.<br /><br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th >Offset</th>
      <th >Size (data type)</th>
      <th >Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (dword)</td>
      <td>Starting vertex index</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (dword)</td>
      <td>Count of vertices</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>1 (unsigned byte)</td>
      <td>Indicates whether this polygon is a polygon or a hole (i.e. whether it
        is a section of impassability, or one of passability.)
        The default is that wall shades animations from both sides - it is
        modified by flag.<br />
        <div class="indent1">
          bit 0 : Shade wall<br />
          bit 1 : Hovering.<br />
          bit 2 : Cover animations<br />
          <span class="unknown">bit 3 : Cover animations</span><br />
          <span class="unknown">bit 4 : unknown, unused ?&nbsp;</span><br />
          <span class="unknown">bit 5 : unknown, unused ?&nbsp;</span><br />
          <span class="unknown">bit 6 : unknown, unused ?&nbsp;</span><br />
          <span class="unknown">bit 7 : Door?</span><br />
        </div>
      </td>
    </tr>
    <tr>
      <td>0x0009</td>
      <td>1 (unknown)</td>
      <td><span class="unknown">Unknown... usually value FF</span></td>
    </tr>
    <tr>
      <td>0x000a</td>
      <td>2 (word)</td>
      <td>Min X coord of bounding box</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>2 (word)</td>
      <td>Max X coord of bounding box</td>
    </tr>
    <tr>
      <td>0x000e</td>
      <td>2 (word)</td>
      <td>Min Y coord of bounding box</td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>2 (word)</td>
      <td>Max Y coord of bounding box</td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="wedV1_3_PolygonIndices">WED V1.3 Polygon index lookup table</a></div><br />
<div class="indent1">
Like all the lookup tables in these files, this maps a (start,count) pair (in
this case, from the <a href="#wedV1_3_WallGroup">wall group table</a>) into
a set of polygon indices (from the <a href="#wedV1_3_Polygon">polygon table</a>).
This is essentially a table of little-endian 16-bit integers which are indices
into the polygon table.<br />
</div>
<br />

<div class="fileheader"><a name="wedV1_3_Vertices">WED V1.3 Vertices</a></div><br />
<div class="indent1">
This is a table of (x,y) pairs of vertices. Each x and y is, again, a little-endian
16-bit integer, embodying an onscreen coordinate.<br /><br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>2 (word)</td>
      <td>X coordinate</td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td>2 (word)</td>
      <td>Y coordinate</td>
    </tr>
  </tbody>
</table>
</div>
</body>
</html>
