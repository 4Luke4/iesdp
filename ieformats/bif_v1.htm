<html>
<head>
<link rel="stylesheet" type="text/css" href="general.css" />
</head>
<body>
<div class="title_main">BIFF file format</div>
<br />
<div class="fileheader">Applies to:</div>
<div class="indent1">BG1, BG1: TotS, BG2, BG2: ToB, PST, IWD, IWD:HoW, IWD:TotL, IWD2</div>
<br />

<div class="fileheader">File versions</div>
<div class="indent1">
<a href="#bif_v1">BIF</a> (BG1, IWD1, PST)<br />
<a href="#bifc_v1">BIFC</a> (IWD1)<br />
<a href="#bifc_v1.0">BIFC 1.0</a> (BG2)<br />
</div>
<br />

<div class="fileheader">General Description</div>
<div class="indent1">
This is a simple archive format, used both to simplify organization of the files, as well as to group together entire areas. Some BIF files are grouped together because of common functionality; for instance, all the .dlg files are gathered together into a single BIF file in Planescape: Torment. Other bif files, such as AR4800.BIF represent the entirety of an area's terrain (i.e. not its containers, actors, or items). These BIF files contain, typically:<br />
<div class="indent1">
  <li>1+ .wed file, detailing how the tiles are to be drawn to the screen (i.e. which are animated, which are linked to the opening of which door, etc.) and where walls are (for clipping of actor graphics)
  <li>1+ .tis file, which contains all the tile data for the area
  <li>1 .mos file which is the overhead map of the region
  <li>3 or 4 small bitmap files which contain one pixel for each tile needed to cover the region.</li>
</div>
<br />
The three (or four) bitmaps, are named xxxxxxHT.BMP, xxxxxxLM.BMP, xxxxxxSR.BMP, and (when there are four bitmaps) xxxxxxLN.BMP.
<div class="indent1">
  <li>xxxxxxHT.BMP: Height-map, which gives the altitude of each tile cell in the associated wed file
  <li>xxxxxxLM.BMP: Light-map, giving the level of illumination (or shadow) of each tile cell on the map. (Called a LUM-map by the developers.)
  <li>xxxxxxLN.BMP: When present, this is the same as xxxxxxLM.BMP, but for night-time only. When present, there will also be a second wed     file to be used only at night.
  <li>xxxxxxSR.BMP: Search Map. Used for path-finding, and marking map sections as passable/water/etc</li>
</div>
<br />
</div>

<div class="fileheader"><a name="bif_v1">BIFF V1</a></div>
<div class="indent1">
Overall structure:<br />
<div class="indent1">
  <li><a href="#bif_v1_Header">Header</a>
  <li><a href="#bif_v1_FileEntry">File entries</a>
  <li><a href="#bif_v1_TilesetEntry">Tileset entries</a>
  <li><em>Data for the contained files</em></li>
</div>
<br />
</div>

<div class="fileheader"><a name="bif_v1_Header">BIFF V1 Header</a></div>
<br />
<div class="indent1">
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (char array)</td>
      <td>Signature ('BIFF')</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (char array)</td>
      <td>Version ('V1 ')</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Number of <a href="#BIFFV1_FileEntry">file entries</a></td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>4 (dword)</td>
      <td>Number of <a href="#BIFFV1_TilesetEntry">tileset entries</a></td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>4 (dword)</td>
      <td>Offset of <a href="#bif_v1_FileEntry">file entries</a> (from start
        of file). <a href="#bif_v1_TilesetEntry">Tileset entries</a>, if
        any, immediately follow the <a href="#bif_v1_FileEntry">file entries</a>.</td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="bif_v1_FileEntry">BIFF V1 File Entries</a></div>
<div class="indent1">
<br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (dword)</td>
      <td>Resource locator <br />
      (NB: On disk, only bits 0-13 are matched upon. They are matched against the 
      file index in the &quot;resource locator&quot; field from the 
      KEY file resource entries which claim to exist in this BIFF.</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (dword)</td>
      <td>Offset to resource data from start of file</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Size (bytes) of this resource (file).</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>2 (word)</td>
      <td>Type of this resource. (See the table of resTypes for a list of which values are applicable to this field</td>
    </tr>
    <tr>
      <td>0x000e</td>
      <td>2 (word)</td>
      <td><span class="unknown">Unknown. Part of the previous field? (Or only used in the memory image?)</span></td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="bif_v1_TilesetEntry">BIFF V1 Tileset Entries</a></div>
<div class="indent1">
<br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (dword)</td>
      <td>Resource locator <br />
        (NB: On disk, only bits 14-19 are matched upon. They are matched against the tileset 
        index in the &quot;resource locator&quot; field from the 
        KEY file resource entries which claim to exist in this BIFF.</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (dword)</td>
      <td>Offset to resource data from start of file</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Number of tiles in this resource (file).</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>4 (dword)</td>
      <td>Size (bytes) of each tile in this resource (file).</td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>2 (word)</td>
      <td>Type of this resource. (These resources are always type 0x3eb (TIS files), but see the 
      table of resTypes for a list of which values are applicable to this field</td>
    </tr>
    <tr>
      <td>0x0012</td>
      <td>2 (word)</td>
      <td><span class="unknown">Unknown. Part of the previous field? (Or only used in the memory image?)</span></td>
    </tr>
  </tbody>
</table>
</div>
<br />


<div class="title_main">BIFC V1 file format</div>

<div class="fileheader"><a name="bifc_v1">BIFC V1</a></div>
<div class="indent1">
Overall structure:<br />
<div class="indent1">
  <li><a href="#bifc_v1_Header">Header</a>
  <li><em>Compressed file data</em></li>
</div>
This format is identical to the SAV file format, except for the first 8 bytes, which are 'BIF V1.0' for these files,
and 'SAV V1.0' for SAV files. The data, once uncompressed, is formatted as a
normal BIF file, as seen above. Note that the SAV files can hold more than one
compressed file. It is unknown whether this occurs also in CBF files. The
compressed format is as follows:<br />
</div>
<br />
<div class="fileheader"><a name="bifc_v1_Header">Header</a></div>
<div class="indent1">
<br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (char array)</td>
      <td>Signature ('BIF ')</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (char array)</td>
      <td>Version ('V1.0')</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Length of filename</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>variable (ASCIIZ char array)</td>
      <td>Filename (length specified by previous field)</td>
    </tr>
    <tr>
      <td>sizeof(filename)+0x0010</td>
      <td>4 (dword)</td>
      <td>Uncompressed data length</td>
    </tr>
    <tr>
      <td>sizeof(filename)+0x0014</td>
      <td>4 (dword)</td>
      <td>Compressed data length</td>
    </tr>
    <tr>
      <td>sizeof(filename)+0x0018</td>
      <td>variable (raw data)</td>
      <td>Compressed data (length in bytes specified by previous field)</td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="title_main">BIFC V1.0 file format</div>

<div class="fileheader"><a name="bifc_v1.0">BIFC V1.0 (compressed)</a></div>
<div class="indent1">
Overall structure:<br />
<div class="indent1">
  <li><a href="#bifc_v1.0_Header">Header</a>
  <li><a href="#bifc_v1.0_Blocks">zlib-compressed blocks</a></li>
</div>
The file is broken up into blocks (typically 8192 bytes apiece), which are
compressed separately. The blocks are stored one right after another,
immediately after the header. Each block consists of an uncompressed size and a
compressed size, and then the data, compressed by zlib.<br />
</div>
<br />

<div class="fileheader"><a name="bifc_v1.0_Header">Header</a></div>
<br />
<div class="indent1">
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (char array)</td>
      <td>Signature ('BIFC')</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (char array)</td>
      <td>Version ('V1.0')</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Uncompressed BIF size</td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="bifc_v1.0_Blocks">Compressed Blocks</a></div>
<div class="indent1">
<br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (data type)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (dword)</td>
      <td>Decompressed size</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (dword)</td>
      <td>Compressed size</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>varies (bytes)</td>
      <td>Compressed data</td>
    </tr>
  </tbody>
</table>
</div>
</body>
</html>
