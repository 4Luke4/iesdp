<html>
<head>
<link rel="stylesheet" type="text/css" href="general.css" />
</head>
<body>
<div class="title_main">SPL file format</div>
<br />
<div class="fileheader">Applies to:</div>
<div class="indent1">BG1, BG1: TotS, BG2, BG2: ToB, PST, IWD, IWD:HoW, IWD:TotL</div>
<br />

<div class="fileheader">General Description</div>
<div class="indent1">
This file describes any spells or character abilities which operate in a similar manner to spells. Innate abilities and such are handled via these files, as are priest and mage spells. In composition, this file is very, very similar to the <a href="ITMformat.htm"> ITM</a> file format. It seems likely that some cut-n-paste coding occurred during the creation of the SPL module (or the ITM module). The physical appearance of the two editors is quite similar, the spell editor looking a lot like the item editor minus a bunch of options which are only relevant to items. Glance over the list of offsets and types in the <a href="ITMformat.htm"> ITM</a> file and compare to the offsets and types here. The purpose of some of these fields may never actually be established, since some of them are not actually used in any items in the games we have available to us. Most notable among these are the 2 blank resrefs, which are  recognizable as resrefs only because thanks to the wonders of uninitialized data buffers, the editors used in creating these games typically leave one of a handful of easily recognizable signatures when writing an &quot;empty&quot; resref.<br />
</div>
<br />

<div class="center"><img border="0" src="../images/spl.jpg" width="610" height="291"></div>
<table align="center">
  <tr>
    <td><img src="../images/red.jpg" width="10" height="10"></td>
    <td><strong>Header:</strong>Size=114 Bytes</td>
    <td><img src="../images/blue.jpg" width="10" height="10"></td>
    <td><strong>Ext. Header:</strong> Size= 40 Bytes</td>
    <td><img src="../images/green.jpg" width="10" height="10"></td>
    <td><strong>Feature Block:</strong> Size=48 Bytes</td>
  </table>
<br />

<div class="fileheader">Detailed Description</div>
<div class="indent1">
In summary, spl files consist of a main header, none or more extended headers (each containing none or more feature blocks), and none or more casting feature blocks.<br />
All the feature blocks are stored as a continuos data segment, with each extended header containing an offset into this data, and the main header containing an offset into this data for the casting feature blocks.<br />
<br />
Overall structure:<br />
<div class="indent1">
  <li>
    <a href="#splv1_Header">Header</a>
  <li>
    <a href="#splv1_Extended_Header">Extended Headers</a>
  <li>
     <a href="#splv1_Feature_Block">Feature Blocks</a>
</div>
</div>
<br />
</div>

<div class="fileheader"><a name="splv1_Header">Header</a></div><br />
<div class="indent1">
Every spell file contains a header. It contains the basic properties of the spell represented by the file.<br />
<br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (datatype)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>4 (char array)</td>
      <td>Signature ('SPL ')</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (char array)</td>
      <td>Version ('V1   ')</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Spell Name - Unidentified (strref)</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>4 (dword)</td>
      <td>Spell Name - Identified (strref) (usu. -1)</td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>8 (resref)</td>
      <td>Completion Sound</td>
    </tr>
    <tr>
      <td>0x0018</td>
      <td>4 (dword)</td>
      <td><a href="#Header_Flags"> Flags</a></td>
    </tr>
    <tr>
      <td>0x001c</td>
      <td>2 (word)</td>
      <td>SpellType:
        <div class="indent1">
          0=Special<br />
          1=Wizard<br />
          2=Cleric<br />
          3=Psionic<br />
          4=Innate<br />
          5=Bardsong<br />
        </div>
      </td>
    </tr>
    <tr>
      <td>0x001e</td>
      <td>2 (word)</td>
      <td><a href="#Exclusion_Flags"> Exclusion Flags</a></td>
    </tr>
    <tr>
      <td>0x0020</td>
      <td>2 (word)</td>
      <td>Priest Type. Grant spell to divine magic users of type:
        <div class="indent1">
          0x0000=Any<br />
          0x4000=Any (except Cleric/Paladin)<br />
          0x8000=Any (except Druid/Ranger)<br />
        </div>
      </td>
    </tr>
    <tr>
      <td>0x0022</td>
      <td>2 (word)</td>
      <td><a href="#Header_Casting_Graphics"> Casting Graphics </a></td>
    </tr>
    <tr>
      <td>0x0024</td>
      <td>1 (char)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0025</td>
      <td>2 (word)</td>
      <td>Primary Type (Spell school) (IWD: school.2da, BG2:mschool.2da)</td>
    </tr>
    <tr>
      <td>0x0027</td>
      <td>1 (char)</td>
      <td>Secondary Type (BG2:msectype.2da)</td>
    </tr>
    <tr>
      <td>0x0028</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x002c</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0030</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0034</td>
      <td>4 (dword)</td>
      <td>Spell Level</td>
    </tr>
    <tr>
      <td>0x0038</td>
      <td>2 (word)</td>
      <td><span class="unknown">Unknown (usu. 1)</span></td>
    </tr>
    <tr>
      <td>0x003a</td>
      <td>8 (resref)</td>
      <td>SpellBook Icon</td>
    </tr>
    <tr>
      <td>0x0042</td>
      <td>2 (word)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0044</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0048</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x004c</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0050</td>
      <td>4 (dword)</td>
      <td>Spell Description - Unidentified (strref)</td>
    </tr>
    <tr>
      <td>0x0054</td>
      <td>4 (dword)</td>
      <td>Spell Description - Identified (strref) (usu. -1)</td>
    </tr>
    <tr>
      <td>0x0058</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x005c</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0060</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0064</td>
      <td>4 (dword)</td>
      <td>Extended Header offset</td>
    </tr>
    <tr>
      <td>0x0068</td>
      <td>2 (word)</td>
      <td>Extended Header count</td>
    </tr>
    <tr>
      <td>0x006a</td>
      <td>4 (dword)</td>
      <td>Feature Block Table offset</td>
    </tr>
    <tr>
      <td>0x006e</td>
      <td>2 (word)</td>
      <td>Casting Feature Block offset</td>
    </tr>
    <tr>
      <td>0x0070</td>
      <td>2 (word)</td>
      <td>Casting Feature Block count</td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="splv1_Extended_Header">Extended Header</a></div><br />
<div class="indent1">
If a spell does anything and/or has level dependent effects then the spell file contains an extended header. One Extended Header is required for each different level that has different values to the effects. The Extended Headers must be ordred according to increasing level, else the game may crash.<br />
<br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (datatype)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>1 (char)</td>
      <td>Spell Form</td>
    </tr>
    <tr>
      <td>0x0001</td>
      <td>1 (char)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td>1 (char)</td>
      <td>Location</td>
    </tr>
    <tr>
      <td>0x0003</td>
      <td>1 (char)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>8 (resref)</td>
      <td>Memorised Icon</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>1 (char)</td>
      <td>Target:
        <div class="indent1">
          0 = Invalid (cannot be selected)<br />
          1 = Creature<br />
          2 = Inventory<br />
          3 = Dead char<br />
          4 = Area<br />
          5 = Self<br />
          6 = Crash<br />
          7 = None (Self, ignores game pause)<br />
        </div>
      </td>
    </tr>
    <tr>
      <td>0x000d</td>
      <td>1 (char)</td>
      <td>Target Number</td>
    </tr>
    <tr>
      <td>0x000e</td>
      <td>2 (word)</td>
      <td>Range</td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>2 (word)</td>
      <td>Level Required</td>
    </tr>
    <tr>
      <td>0x0012</td>
      <td>4 (dword)</td>
      <td>Casting Time</td>
    </tr>
    <tr>
      <td>0x0016</td>
      <td>2 (word)</td>
      <td>Dice Sides (unused)</td>
    </tr>
    <tr>
      <td>0x0018</td>
      <td>2 (word)</td>
      <td>Dice Thrown (unused)</td>
    </tr>
    <tr>
      <td>0x001a</td>
      <td>2 (word)</td>
      <td>Enchanted (?)</td>
    </tr>
    <tr>
      <td>0x001c</td>
      <td>2 (word)</td>
      <td>Damage Type (unused)</td>
    </tr>
    <tr>
      <td>0x001e</td>
      <td>2 (word)</td>
      <td>Feature Count</td>
    </tr>
    <tr>
      <td>0x0020</td>
      <td>2 (word)</td>
      <td>Feature Offset</td>
    </tr>
    <tr>
      <td>0x0022</td>
      <td>2 (word)</td>
      <td>Charges (usu. 1) (unused?)</td>
    </tr>
    <tr>
      <td>0x0024</td>
      <td>2 (word)</td>
      <td>Charge depletion behvaiour (usu. 1) (unused?)</td>
    </tr>
    <tr>
      <td>0x0026</td>
      <td>2 (word)</td>
      <td>Projectile (BG2:projectl.ids)</td>
    </tr>
  </tbody>
</table>
</div>
<br />

<div class="fileheader"><a name="splv1_Feature_Block">Feature Block</a></div><br />
<div class="indent1">
Any spell that does anything will contain one or more Feature Blocks. Every Feature Block represents one special ability or effect of a spell.<br />
<br />
<table border="1" width="98%">
  <colgroup>
    <col width="5%">
    <col width="12%">
    <col width="*">
  </colgroup>
  <thead>
    <tr>
      <th>Offset</th>
      <th>Size (datatype)</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>2 (word)</td>
      <td>Opcode Number</td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td>1 (char)</td>
      <td>Target:
        <div class="indent1">
          0=None<br />
          1=Self<br />
          2=Pre-Target<br />
          3=Party<br />
          4=Global<br />
          5=Non-Party<br />
          6=Non-evil<br />
          7=<span class="unknown">Unknown</span><br />
          8=Except Self<br />
          9=Original Caster<br />
          10=<span class="unknown">Unknown</span><br />
          11=<span class="unknown">Unknown</span><br />
          12=<span class="unknown">Unknown</span><br />
          13=<span class="unknown">Unknown</span><br />
        </div>
      </td>
    </tr>
    <tr>
      <td>0x0003</td>
      <td>1 (char)</td>
      <td>Power</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>4 (dword)</td>
      <td>Parameter 1</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>4 (dword)</td>
      <td>Parameter 2</td>
    </tr>
    <tr>
      <td>0x000c</td>
      <td>1 (char)</td>
      <td>Timing Mode:
        <div class="indent1">
          0=Duration<br />
          1=Permanent<br />
          2=While equipped<br />
          3=Delayed Duration<br />
          4=Delayed<br />
          5=Delayed (transforms to 8)<br />
          6=Duration (transforms to 4096?)?<br />
          7=Permanent?<br />
          8=Permanent (unsaved)<br />
          9=Permanent (after Death)<br />
          10=Trigger<br />
        </div>
      </td>
    </tr>
    <tr>
      <td>0x000d</td>
      <td>1 (char)</td>
      <td>Resistance:
        <div class="indent1">
          0=Nonmagical<br />
          1=Dispell/Not Bypass<br />
          2=Not Dispell/NotBypass<br />
          3=Dispell/Bypass<br />
        </div>
      </td>
    </tr>
    <tr>
      <td>0x000e</td>
      <td>4 (dword)</td>
      <td>Duration</td>
    </tr>
    <tr>
      <td>0x0012</td>
      <td>1 (char)</td>
      <td>Probability 1</td>
    </tr>
    <tr>
      <td>0x0013</td>
      <td>1 (char)</td>
      <td>Probability 2</td>
    </tr>
    <tr>
      <td>0x0014</td>
      <td>8 (resref)</td>
      <td>Resource</td>
    </tr>
    <tr>
      <td>0x001c</td>
      <td>4 (dword)</td>
      <td>Dice Thrown</td>
    </tr>
    <tr>
      <td>0x0020</td>
      <td>4 (dword)</td>
      <td>Dice Sides</td>
    </tr>
    <tr>
      <td>0x0024</td>
      <td>4 (dword)</td>
      <td>Saving Throw Type: <br />
        <div class="indent1">
          0=None<br />
          1=Spells<br />
          2=Breathe<br />
          4=Death<br />
          8=Wands<br />
          16=Polymorph<br />
          </div>
         NB. If more than 1 saving throw type is specified, the target rolls against their best save.<br />
      </td>
    </tr>
    <tr>
      <td>0x0028</td>
      <td>4 (dword)</td>
      <td>Saving Throw Bonus</td>
    </tr>
    <tr>
      <td>0x002c</td>
      <td>4 (dword)</td>
      <td><span class="unknown">Unknown</span></td>
    </tr>
  </tbody>
</table>
</div>
<br />

<hr>
<br />
<a id="Header_Flags"><div class="actionheader"> Header Flags </div>
<br />
<div class="indent1">
<table border="1" width="98%">
  <colgroup>
    <col width="20%">
    <col width="20%">
    <col width="20%">
    <col class="col4" width="20%">
    <col class="col4" width="20%">
  </colgroup>
  <thead>
    <tr>
      <th>Bit </th>
      <th>Byte 1</th>
      <th>Byte 2</th>
      <th>Byte 3</th>
      <th>Byte 4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> Not in combat </td>
      <td> <span class="unknown"> Unknown </span></td>
    </tr>
    <tr>
      <td>1</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
    </tr>
    <tr>
      <td>2</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> Hostile Spell</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
    </tr>
    <tr>
      <td>3</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> No LOS required</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
    </tr>
    <tr>
      <td>4</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
    </tr>
    <tr>
      <td>5</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> Outdoors only</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
    </tr>
    <tr>
      <td>6</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> HLA (?) </span></td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
    </tr>
    <tr>
      <td>7</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> Trigger/Contingency</td>
      <td> <span class="unknown"> Unknown </span></td>
      <td> <span class="unknown"> Unknown </span></td>
    </tr>
  </tbody>
</table>
</div>
<br />
<a id="Exclusion_Flags"><div class="actionheader"> Exclusion Flags </div>
<br />
<div class="indent1">
bit 0: Exclude Chaotic priests. (BG2 & HoW)<br />
bit 1: Exclude Evil priests. (BG2 & HoW)<br />
bit 2: Exclude Good priests. (BG2 & HoW)<br />
bit 3: Exclude GENeutral priests. (BG2 & HoW)<br />
bit 4: Exclude Lawful priests. (BG2 & HoW)<br />
bit 5: Exclude LCNeutral priests. (BG2 & HoW)<br />
bit 6: Exclude Abjurers<br />
bit 7: Exclude Conjurers<br />
bit 8: Exclude Diviners<br />
bit 9: Exclude Enchanters<br />
bit 10: Exclude Illusionists<br />
bit 11: Exclude Invokers<br />
bit 12: Exclude Necromancers<br />
bit 13: Exclude Transmuters<br />
bit 14: Wild Magic (exclude Generalists) (BG2)<br />
bit 15: Unused<br />
<br />
NB.Alignment and School exclusion bits cannot be combined.<br />
</div>
<br />
<a id="Header_Casting_Graphics"><div class="actionheader"> Casting Graphics</div>
<br />
<strong>BG1,BG2,IWD</strong><br />
<div class="indent1">
00<br />
&nbsp;&nbsp;&nbsp;&nbsp;...No animation<br />
08<br />
09 Necromancy<br />
10 Alteration<br />
11 Enchantment<br />
12 Abjuration<br />
13 Illusion<br />
14 Conjuration<br />
15 Invocation<br />
16 Divination<br />
17 White sparks<br />
18 Black sparks<br />
19 White sparks<br />
20 White sparks<br />
21 White sparks<br />
22 White -> red sparks<br />
23 White -> purple/red sparks<br />
24 White -> red sparks<br />
26 White sparks<br />
32 White sparks<br />
34 White sparks<br />
56461 No animation<br />
65535 No animation<br />
<br />
NB. The 'spark' entries are related to sprklclr.2da (and probably opcode #41)<br />
</div>
<br />
<strong>PST</strong><br />
<div class="indent1">
35: Abjuration<br />
36: Alteration<br />
37: Conjuration<br />
38: Enchantment<br />
39: Divination<br />
40: Illusion<br />
41: Invocation<br />
42: Necromancy<br />
44: Special (Innate) Skill<br />
</div>
</body>
</html>
